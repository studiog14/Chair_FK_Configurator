<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chair Configurator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #viewer {
      flex: 1;
      background: #f0f0f0;
    }
    #sidebar {
      width: 510px;
      background: white;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
      align-items: flex-start;
      gap: 10px;
    }
    .chair-tile {
      width: 120px;
      height: 140px;
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 5px;
      background: #fafafa;
      transition: transform 0.2s;
    }
    .chair-tile:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .chair-tile img {
      max-width: 100%;
      max-height: 80px;
      object-fit: contain;
    }
    .chair-tile span {
      font-size: 12px;
      text-align: center;
      white-space: pre-line;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <div id="viewer"></div>
  <div id="sidebar"></div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

    const viewer = document.getElementById('viewer');
    const sidebar = document.getElementById('sidebar');

    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, physicallyCorrectLights: true });
    renderer.setClearColor(0xf0f0f0);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;

    viewer.appendChild(renderer.domElement);

    // Usuwamy AmbientLight lub bardzo słabe
    // const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
    // scene.add(ambientLight);

    // DirectionalLight nadal można mieć, ale na mniejszą moc
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
    directionalLight.position.set(5, 10, 7.5);
    scene.add(directionalLight);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;

    const pmremGenerator = new THREE.PMREMGenerator(renderer);
    pmremGenerator.compileEquirectangularShader();

    // Ładujemy HDRI i ustawiamy je jako environment oraz tło sceny
    new RGBELoader()
      .setPath('hdr/')
      .load('studio_small_08_2k.hdr', (texture) => {
        const envMap = pmremGenerator.fromEquirectangular(texture).texture;
        scene.environment = envMap;        // środowisko do odbić i oświetlenia PBR
        scene.background = envMap;         // ustawiamy HDRI jako tło
        texture.dispose();
        pmremGenerator.dispose();
      }, undefined, (err) => {
        console.warn('Nie udało się załadować HDRI:', err);
      });

    let currentModel = null;
    const loader = new GLTFLoader();

    function loadModel(name) {
      const modelPath = `chairs/${name}.glb`;
      loader.load(
        modelPath,
        (gltf) => {
          if (currentModel) scene.remove(currentModel);
          currentModel = gltf.scene;
          scene.add(currentModel);

          // Przesuwamy model do środka i na ziemię
          const box = new THREE.Box3().setFromObject(currentModel);
          const size = new THREE.Vector3();
          const center = new THREE.Vector3();
          box.getSize(size);
          box.getCenter(center);

          currentModel.position.x -= center.x;
          currentModel.position.z -= center.z;
          currentModel.position.y -= box.min.y;

          // Kamerę ustawiamy tak, by dobrze widzieć model
          const marginFactor = 1.8;
          const maxDim = Math.max(size.x, size.y, size.z) * marginFactor;

          const fov = THREE.MathUtils.degToRad(camera.fov);
          const cameraDistance = maxDim / (2 * Math.tan(fov / 2));

          const angleY = THREE.MathUtils.degToRad(-30);
          const angleX = THREE.MathUtils.degToRad(25);

          const camX = cameraDistance * Math.sin(angleY) * Math.cos(angleX);
          const camZ = cameraDistance * Math.cos(angleY) * Math.cos(angleX);
          const camY = cameraDistance * Math.sin(angleX);

          camera.position.set(camX, camY, camZ);

          controls.target.set(0, size.y * 0.5, 0);
          controls.update();
        },
        undefined,
        (error) => {
          console.error('Błąd ładowania modelu:', error);
        }
      );
    }

    function resizeRendererToViewer() {
      const rect = viewer.getBoundingClientRect();
      renderer.setSize(rect.width, rect.height);
      camera.aspect = rect.width / rect.height;
      camera.updateProjectionMatrix();
    }

    window.addEventListener('load', resizeRendererToViewer);
    window.addEventListener('resize', resizeRendererToViewer);

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    fetch('https://opensheet.elk.sh/1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78/Dane')
      .then((res) => res.json())
      .then((data) => {
        const chairs = data.filter(
          (item) => item.Grupa === 'krzesło' || item.Grupa === 'kubełek'
        );
        chairs.forEach((chair) => {
          const tile = document.createElement('div');
          tile.className = 'chair-tile';
          tile.title = chair.Nazwa;

          const img = document.createElement('img');
          img.src = chair.Obrazek || '';
          img.alt = chair.Nazwa;

          const label = document.createElement('span');
          const cena = chair.Cena ? chair.Cena.trim() : 'brak ceny';
          label.textContent = `${chair.Nazwa}\nCena ${cena}`;

          tile.appendChild(img);
          tile.appendChild(label);

          tile.addEventListener('click', () => loadModel(chair.Nazwa));
          sidebar.appendChild(tile);
        });

        if (chairs.length > 0) {
          loadModel(chairs[0].Nazwa);
        }
      })
      .catch((err) => {
        console.error('Błąd pobierania arkusza:', err);
      });
  </script>
</body>
</html>
