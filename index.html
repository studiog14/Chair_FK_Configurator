<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Konfigurator krzeseł</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #viewer {
        flex: 1;
        background-color: #f9f9f9;
        position: relative;
      }

      #ui {
        width: 510px;
        background-color: #fff;
        overflow-y: auto;
        padding: 20px;
        border-left: 1px solid #ddd;
      }

   #loadingOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
  pointer-events: auto;
}

#loadingContent {
  display: flex;
  flex-direction: column;  /* <-- to ustawia wszystko pionowo */
  align-items: center;
  gap: 20px;
  text-align: center;
}

#loadingLogo {
  width: 250px;
  height: auto;
  opacity: 0.9;
}

#loadingIcon {
  width: 50px;
  height: 50px;
  animation: spin 1.2s linear infinite;
  opacity: 0.8;
}

#loadingText {
  font-size: 1.2em;
  color: #333;
  opacity: 0.8;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

      /* Spinner - animowane kółko */
      #loadingOverlay .spinner {
        border: 5px solid #f3f3f3; /* jasnoszary */
        border-top: 5px solid #3498db; /* niebieski */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .tile {
        width: 140px;
        margin: 10px;
        display: inline-block;
        cursor: pointer;
      }

      .tile img {
        width: 100%;
        height: auto;
        border-radius: 6px;
        box-shadow: 0 0 4px rgba(0,0,0,0.1);
      }

      .tile div {
        text-align: center;
        margin-top: 5px;
      }

      h3 {
        margin-top: 0;
      }

      .tile-price {
  font-size: 0.9em;
  color: #555;
  margin-top: 4px;
}

html, body {
  overflow: hidden;
  height: 100%;
}

 .tile {
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.3s, box-shadow 0.3s;
  padding: 6px;
  border-radius: 6px;
  user-select: none;
}

.tile.hover {
  border-color: #888;
  box-shadow: 0 0 6px rgba(0,0,0,0.15);
}

.tile.selected {
  border-color: #007bff;
  box-shadow: 0 0 10px #007bff;
  background-color: #e7f1ff;
}


  /* Styl dla wszystkich kafelków (tiles) i głównych przycisków kategorii */
  .tile,
  .main-category-btn {
    border-radius: 10px;
    border: 2.5px solid transparent;
    transition: background-color 0.25s ease, border-color 0.25s ease;
    cursor: pointer;
  }

  /* Aktywne zaznaczenie (prostokąt z zaokrąglonymi rogami) */
  .active {
    border-color: #0078d7;
    background-color: rgba(0, 120, 215, 0.15);
  }

  /* Efekt hover dla wszystkich przycisków i kafelków */
  .tile:hover,
  .main-category-btn:hover {
    background-color: rgba(0, 120, 215, 0.08);
    border-color: #3399ff;
  }

  /* Usunięcie domyślnego outline na focus - zamiast niego ramka */
  .tile:focus,
  .main-category-btn:focus {
    outline: none;
    border-color: #0078d7;
    background-color: rgba(0, 120, 215, 0.15);
  }
</style>

    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="viewer">
  <div id="loadingOverlay">
    <div id="loadingContent">
      <img id="loadingLogo" src="icons/FK_Logo.jpg" alt="Logo" />
      <img id="loadingIcon" src="icons/CircleLoad.png" alt="Loading..." />
      <div id="loadingText">Loading...</div>
    </div>
  </div>
</div>
<div id="ui"></div>

   <script type="module">
  import * as THREE from "three";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 510) / window.innerHeight, 0.1, 100);
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth - 510, window.innerHeight);
  renderer.shadowMap.enabled = false;
  document.getElementById("viewer").appendChild(renderer.domElement);

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.85);
  directionalLight.position.set(5, 10, 7);
  directionalLight.castShadow = false;
  scene.add(directionalLight);

  const loader = new GLTFLoader();
  let currentModel;
  let modelCenter = new THREE.Vector3(0, 0, 0);
  const loadingOverlay = document.getElementById("loadingOverlay");

  let targetCameraZ = camera.position.z = 5;
  const minCameraZ = 0.6;
  const maxCameraZ = 1.8;
  const zoomSpeed = 0.001;
  const zoomLerpFactor = 0.1;

  const controls = { userIsInteracting: false };
  let previousMouseX = 0;
  let previousMouseY = 0;

  function onMouseDown(event) {
    controls.userIsInteracting = true;
    previousMouseX = event.clientX;
    previousMouseY = event.clientY;
  }

  function onMouseMove(event) {
    if (controls.userIsInteracting && currentModel) {
      const deltaX = event.clientX - previousMouseX;
      const deltaY = event.clientY - previousMouseY;

      currentModel.rotation.y += deltaX * 0.005;
      currentModel.rotation.x += deltaY * 0.003;
      currentModel.rotation.x = Math.min(Math.max(currentModel.rotation.x, -Math.PI / 4), Math.PI / 4);

      previousMouseX = event.clientX;
      previousMouseY = event.clientY;
    }
  }

  function onMouseUp() {
    controls.userIsInteracting = false;
  }

  window.addEventListener("mousedown", onMouseDown);
  window.addEventListener("mousemove", onMouseMove);
  window.addEventListener("mouseup", onMouseUp);

  window.addEventListener("wheel", (event) => {
    if (!currentModel) return;
    targetCameraZ += event.deltaY * zoomSpeed;
    targetCameraZ = Math.min(Math.max(targetCameraZ, minCameraZ), maxCameraZ);
  });

  function loadModel(name) {
  const path = `chairs/${name}.glb`;
  loadingOverlay.style.display = "flex";

  if (currentModel) {
    scene.remove(currentModel);
    currentModel.traverse((child) => {
      if (child.geometry) child.geometry.dispose();
      if (child.material) {
        if (Array.isArray(child.material)) {
          child.material.forEach((mat) => mat.dispose());
        } else {
          child.material.dispose();
        }
      }
    });
    currentModel = null; // ważne - wyczyść referencję
  }

  loader.load(
    path,
    (gltf) => {
      currentModel = gltf.scene;
      scene.add(currentModel);

      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      currentModel.position.sub(center);

      const sizeVec = box.getSize(new THREE.Vector3());
      const size = sizeVec.length();

      camera.position.set(0, size * 0.2, size * 1.2);
      targetCameraZ = camera.position.z;
      camera.lookAt(0, 0, 0);

      loadingOverlay.style.display = "none";
    },
    undefined,
    (error) => {
      console.error("❌ Błąd ładowania modelu:", error);
      loadingOverlay.innerHTML = "❌ Błąd ładowania modelu";
      loadingOverlay.style.display = "flex";
    }
  );
}


  function animate() {
    requestAnimationFrame(animate);
    camera.position.z += (targetCameraZ - camera.position.z) * zoomLerpFactor;
    if (currentModel) camera.lookAt(0, 0, 0);
    if (currentModel && !controls.userIsInteracting) currentModel.rotation.y += 0.0005;
    renderer.render(scene, camera);
  }

  animate();

  async function loadSheetData() {
    const res = await fetch("https://opensheet.elk.sh/1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78/Dane");
    const data = await res.json();
    return data;
  }

  function createTile(item, category) {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("data-nazwa", item.Nazwa);
    tile.innerHTML = `
      <img src="${item.Obrazek}" alt="${item.Nazwa}" />
      <div class="tile-title">${item.Nazwa}</div>
      <div class="tile-price">${item.Cena ? item.Cena + ' zł' : ''}</div>
    `;

    tile.addEventListener("click", () => {
      if (category === "chairs") {
        loadModel(item.Nazwa);
      } else if (category === "materials") {
        // Obsługa materiałów – dodaj tutaj jakąś logikę
        console.log("Wybrano materiał:", item.Nazwa);
      }
      setSelectedTile(category, tile);
    });

    tile.addEventListener("mouseenter", () => {
      tile.classList.add("hover");
    });
    tile.addEventListener("mouseleave", () => {
      tile.classList.remove("hover");
    });

    return tile;
  }

  function setSelectedTile(category, selectedTile) {
    const containerId = category === "chairs" ? "section-chairs" : "section-materials";
    const container = document.getElementById(containerId);
    if (!container) return;

    const tiles = container.querySelectorAll(".tile");
    tiles.forEach(tile => {
      tile.classList.toggle("selected", tile === selectedTile);
    });
  }

  function initMaterialButtons(container) {
    const materialTypes = [
      { id: "seat", label: "Siedzisko", iconSrc: "icons/seat.png" },
      { id: "legs", label: "Nogi", iconSrc: "icons/legs.png" },
      { id: "back_inner", label: "Oparcie wewnętrzne", iconSrc: "icons/back_inner.png" },
      { id: "back_outer", label: "Oparcie zewnętrzne", iconSrc: "icons/back_outer.png" },
    ];

    const btnGroup = document.createElement("div");
    btnGroup.style.display = "flex";
    btnGroup.style.gap = "8px";
    btnGroup.style.marginBottom = "10px";

    materialTypes.forEach((mat) => {
      const btn = document.createElement("button");
      btn.className = "material-part-button";
      btn.title = mat.label;
      btn.style.flex = "1";
      btn.style.padding = "6px";
      btn.style.display = "flex";
      btn.style.flexDirection = "column";
      btn.style.alignItems = "center";
      btn.style.border = "1px solid #ccc";
      btn.style.borderRadius = "4px";
      btn.style.background = "#fff";
      btn.style.cursor = "pointer";

      btn.innerHTML = `
        <img src="${mat.iconSrc}" alt="${mat.label}" style="width:24px; height:24px; margin-bottom:4px;" />
        <span style="font-size: 12px;">${mat.label}</span>
      `;

      btn.addEventListener("click", () => {
        // Podświetlenie przycisku materiału
        [...btnGroup.children].forEach(sib => sib.classList.remove("selected"));
        btn.classList.add("selected");
        console.log("Wybrano element:", mat.id);
      });

      btnGroup.appendChild(btn);
    });

    container.appendChild(btnGroup);
  }

  async function initUI() {
    const ui = document.getElementById("ui");

    const buttonsContainer = document.createElement("div");
    buttonsContainer.style.display = "flex";
    buttonsContainer.style.gap = "15px";
    buttonsContainer.style.marginBottom = "20px";
    buttonsContainer.style.justifyContent = "center";

    const chairBtn = document.createElement("button");
    chairBtn.className = "main-category-btn active";
    chairBtn.innerHTML = `
      <img src="icons/chair_icon.png" alt="Krzesła" />
      <span>Krzesła</span>
    `;

    const materialsBtn = document.createElement("button");
    materialsBtn.className = "main-category-btn";
    materialsBtn.innerHTML = `
      <img src="icons/fabric_icon.png" alt="Materiały" />
      <span>Materiały</span>
    `;

    function setActiveButton(activeBtn) {
      [chairBtn, materialsBtn].forEach(btn => {
        btn.classList.toggle("active", btn === activeBtn);
      });
    }

    chairBtn.onclick = () => {
      showCategory("chairs");
      setActiveButton(chairBtn);
    };

    materialsBtn.onclick = () => {
      showCategory("materials");
      setActiveButton(materialsBtn);
    };

    buttonsContainer.appendChild(chairBtn);
    buttonsContainer.appendChild(materialsBtn);
    ui.appendChild(buttonsContainer);

    const data = await loadSheetData();

    const chairs = data.filter(item => item.Grupa === "krzesło" || item.Grupa === "kubełek");
    const materials = data.filter(item => ["tkanina", "drewno", "metal"].includes(item.Grupa));

    // Sekcja krzeseł
    const chairSection = document.createElement("div");
    chairSection.id = "section-chairs";
    const header1 = document.createElement("h3");
    header1.textContent = "Wybierz krzesło";
    chairSection.appendChild(header1);

    const chairGrid = document.createElement("div");
    chairGrid.className = "grid-container";
    chairs.forEach(chair => {
      const tile = createTile(chair, "chairs");
      chairGrid.appendChild(tile);
    });
    chairSection.appendChild(chairGrid);
    ui.appendChild(chairSection);

    // Sekcja materiałów
    const materialsSection = document.createElement("div");
    materialsSection.id = "section-materials";
    materialsSection.style.display = "none";
    const header2 = document.createElement("h3");
    header2.textContent = "Wybierz materiał";
    materialsSection.appendChild(header2);

    initMaterialButtons(materialsSection);

    const materialGrid = document.createElement("div");
    materialGrid.className = "grid-container";
    materials.forEach(material => {
      const tile = createTile(material, "materials");
      materialGrid.appendChild(tile);
    });
    materialsSection.appendChild(materialGrid);

    ui.appendChild(materialsSection);

    function showCategory(cat) {
      if (cat === "chairs") {
        chairSection.style.display = "";
        materialsSection.style.display = "none";
      } else {
        chairSection.style.display = "none";
        materialsSection.style.display = "";
      }
    }

    showCategory("chairs");

    // Auto-load first chair model
    if (chairs.length > 0) {
      loadModel(chairs[0].Nazwa);
      const firstTile = chairGrid.querySelector(".tile");
      setSelectedTile("chairs", firstTile);
    }
  }

  initUI();
</script>



  </body>
</html>
