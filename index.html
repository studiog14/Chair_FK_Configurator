<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Konfigurator krzeseł FK</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script type="importmap">
    {
      "imports": {
        "threepipe": "https://unpkg.com/threepipe@latest/dist/index.mjs",
        "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@latest/dist/index.mjs"
      }
    }
  </script>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
    }
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    #canvas {
      flex: 1 1 0;
      background: #ddd;
    }
    #sidebar {
      flex: 0 0 320px;
      background: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      z-index: 1;
    }
    #selected-chair-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }
    #thumbnails, #legs-thumbnails {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .thumbnail {
      width: 80px;
      height: 80px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: transform 0.2s, border-color 0.2s;
    }
    .thumbnail:hover {
      transform: scale(1.05);
      border-color: #444;
    }
    
  .thumbnail.selected {
    outline: 2px solid #007bff;
    border-radius: 6px;
  }

  #thumbnails img,
  #legs-thumbnails img {
    transition: outline 0.2s ease;
    cursor: pointer;
  }

    hr {
      border: none;
      border-top: 1px solid #ccc;
      margin: 16px 0 12px;
    }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="canvas"></canvas>
    <div id="sidebar">
      <div id="selected-chair-name">Wybrane krzesło: Brak</div>
      <hr />
      <!-- Sekcja miniatur krzeseł -->
<div id="thumbnails"></div>

<!-- Separator i miniaturki nóg -->
<div id="legs-separator" style="display:none; margin:10px 0; border-top:1px solid #aaa;"></div>
<div id="legs-thumbnails" style="display:none; flex-wrap: wrap; gap: 6px;"></div>

<!-- Podsumowanie na dole sidebaru -->
<div id="summary" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; font-family: Arial, sans-serif; font-size: 14px; color: #333;"></div>

  </div>

 <script type="module">
  import * as THREE from 'https://cdn.skypack.dev/three';
  import { GLTFLoader } from 'https://cdn.skypack.dev/three/examples/jsm/loaders/GLTFLoader.js';
  import { OrbitControls } from 'https://cdn.skypack.dev/three/examples/jsm/controls/OrbitControls.js';

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('viewer').appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  camera.position.set(0, 1.5, 3);
  controls.update();

  const ambientLight = new THREE.AmbientLight(0xffffff, 1);
  scene.add(ambientLight);

  const loader = new GLTFLoader();
  const currentModelContainer = new THREE.Group();
  scene.add(currentModelContainer);

  let currentBucketModel = null;
  let currentLegModel = null;
  let selectedChair = null;
  let selectedLeg = null;

  function setBucketModel(bucketModelPath) {
    loader.load(bucketModelPath, function (gltf) {
      if (currentBucketModel) {
        currentModelContainer.remove(currentBucketModel);
      }

      currentBucketModel = gltf.scene;
      currentBucketModel.position.set(0, 0, 0);
      currentModelContainer.add(currentBucketModel);

      if (currentLegModel) {
        setLegModel(currentLegModel.userData.modelPath);
      }

      updateCameraToFitModel();
    });
  }

  function setLegModel(legModelPath) {
    loader.load(legModelPath, function (gltf) {
      if (currentLegModel) {
        currentModelContainer.remove(currentLegModel);
      }

      currentLegModel = gltf.scene;
      currentLegModel.userData.modelPath = legModelPath;
      currentLegModel.position.set(0, -0.45, 0);
      currentModelContainer.add(currentLegModel);

      updateCameraToFitModel();
    });
  }

  function updateCameraToFitModel() {
    const box = new THREE.Box3().setFromObject(currentModelContainer);
    const size = box.getSize(new THREE.Vector3()).length();
    const center = box.getCenter(new THREE.Vector3());

    controls.reset();
    camera.near = size / 100;
    camera.far = size * 100;
    camera.updateProjectionMatrix();

    camera.position.copy(center);
    camera.position.x += size / 2.0;
    camera.position.y += size / 5.0;
    camera.position.z += size / 2.0;
    camera.lookAt(center);
    controls.update();
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  animate();

  // ŁADOWANIE DANYCH Z GOOGLE SHEETS
  fetch('https://opensheet.elk.sh/1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78/Arkusz1')
    .then(response => response.json())
    .then(data => {
      const chairButtons = document.getElementById('chair-buttons');
      const materialButtons = document.getElementById('material-buttons');
      const legButtons = document.getElementById('leg-buttons');

      const chairs = data.filter(item => item.Grupa === 'krzesło' || item.Grupa === 'kubełek');
      const legs = data.filter(item => item.Grupa === 'nogi');

      function renderChairThumbnails(group) {
        chairButtons.innerHTML = '';
        chairs
          .filter(item => item.Grupa === group)
          .forEach(item => {
            const div = document.createElement('div');
            div.classList.add('thumbnail');
            div.innerHTML = `<img src="${item.Obrazek}" alt="${item.Nazwa}"><p>${item.Nazwa}</p>`;
            div.addEventListener('click', () => {
              selectedChair = item;
              selectedLeg = null;
              setBucketModel(`chairs/${item.Nazwa}.glb`);
              if (item.Grupa === 'kubełek') {
                document.getElementById('legs-section').style.display = 'block';
                renderLegsThumbnails();
              } else {
                document.getElementById('legs-section').style.display = 'none';
              }
              updateSummary();
            });
            chairButtons.appendChild(div);
          });
      }

      function renderLegsThumbnails() {
        legButtons.innerHTML = '';
        legs.forEach(item => {
          const div = document.createElement('div');
          div.classList.add('thumbnail');
          div.innerHTML = `<img src="${item.Obrazek}" alt="${item.Nazwa}"><p>${item.Nazwa}</p>`;
          div.addEventListener('click', () => {
            selectedLeg = item;
            setLegModel(`chairs/${item.Nazwa}.glb`);
            updateSummary();
          });
          legButtons.appendChild(div);
        });
      }

      function updateSummary() {
        const summaryDiv = document.getElementById('summary');
        if (!summaryDiv) return;

        let html = '<h3>Podsumowanie</h3>';
        if (selectedChair) {
          html += `<p><strong>Krzesło:</strong> ${selectedChair.Nazwa || ''}</p>`;
          if (selectedChair.Cena) html += `<p><strong>Cena:</strong> ${selectedChair.Cena} PLN</p>`;
        }

        if (selectedChair && selectedChair.Grupa === 'kubełek' && selectedLeg) {
          html += `<p><strong>Nogi:</strong> ${selectedLeg.Nazwa || ''}</p>`;
          if (selectedLeg.Cena) html += `<p><strong>Cena nóg:</strong> ${selectedLeg.Cena} PLN</p>`;
        }

        const chairPrice = selectedChair?.Cena ? parseFloat(selectedChair.Cena) : 0;
        const legPrice = selectedLeg?.Cena ? parseFloat(selectedLeg.Cena) : 0;
        const totalPrice = chairPrice + legPrice;
        html += `<p><strong>Razem:</strong> ${totalPrice.toFixed(2)} PLN</p>`;

        summaryDiv.innerHTML = html;
      }

      // Domyślne ładowanie grupy "krzesło"
      renderChairThumbnails('krzesło');

      document.getElementById('show-chairs').addEventListener('click', () => {
        renderChairThumbnails('krzesło');
        document.getElementById('legs-section').style.display = 'none';
      });

      document.getElementById('show-buckets').addEventListener('click', () => {
        renderChairThumbnails('kubełek');
        document.getElementById('legs-section').style.display = 'block';
      });
    });
</script>



</body>
</html>
