<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>3D Chair Configurator</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }

      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        font-size: 1.5em;
      }

      .ui {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 101;
      }

      .ui button {
        margin-right: 5px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
      }
    </style>

    <!-- Import map -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/"
        }
      }
    </script>
  </head>

  <body>
    <div id="loadingOverlay">Loading 3D model...</div>

    <div class="ui">
      <button onclick="loadModel('models/Fargo.glb')">Fargo</button>
      <button onclick="loadModel('models/Marco.glb')">Marco</button>
    </div>

    <script type="module">
      import * as THREE from 'three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

      const scene = new THREE.Scene();

      const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 1, 5);

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 7);
      scene.add(directionalLight);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.target.set(0, 1, 0);
      controls.update();
      controls.userIsInteracting = false;

      renderer.domElement.addEventListener('pointerdown', () => {
        controls.userIsInteracting = true;
      });

      renderer.domElement.addEventListener('pointerup', () => {
        setTimeout(() => {
          controls.userIsInteracting = false;
        }, 3000);
      });

      const loader = new GLTFLoader();
      let currentModel;

      const loadingOverlay = document.getElementById('loadingOverlay');

      function loadModel(path) {
        console.log('🔄 Ładowanie modelu:', path);
        loadingOverlay.style.display = 'flex';

        if (currentModel) {
          scene.remove(currentModel);
          currentModel.traverse(child => {
            if (child.geometry) child.geometry.dispose();
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach(mat => mat.dispose());
              } else {
                child.material.dispose();
              }
            }
          });
        }

        loader.load(
          path,
          gltf => {
            console.log('✅ Model załadowany:', gltf);
            currentModel = gltf.scene;
            currentModel.position.set(0, 0, 0);
            currentModel.scale.set(1, 1, 1);
            scene.add(currentModel);

            const box = new THREE.Box3().setFromObject(currentModel);
            const size = box.getSize(new THREE.Vector3()).length();
            const center = box.getCenter(new THREE.Vector3());

            camera.position.set(center.x, center.y + size * 0.5, size * 1.5);
            camera.lookAt(center);

            controls.target.copy(center);
            controls.update();

            loadingOverlay.style.display = 'none';
          },
          xhr => {
            if (xhr.lengthComputable) {
              const percent = (xhr.loaded / xhr.total * 100).toFixed(1);
              console.log(`📦 Załadowano: ${percent}%`);
            }
          },
          error => {
            console.error('❌ Błąd ładowania modelu:', error);
            loadingOverlay.textContent = '❌ Error loading model :(';
          }
        );
      }

      function animate() {
        requestAnimationFrame(animate);

        if (currentModel && !controls.userIsInteracting) {
          currentModel.rotation.y += 0.001;
        }

        controls.update();
        renderer.render(scene, camera);
      }

      animate();
      window.loadModel = loadModel;
      loadModel('models/Fargo.glb');

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
