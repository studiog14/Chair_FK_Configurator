<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Konfigurator krzeseł</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #viewer {
        flex: 1;
        background-color: #f9f9f9;
        position: relative;
      }

      #ui {
        width: 510px;
        background-color: #fff;
        overflow-y: auto;
        padding: 20px;
        border-left: 1px solid #ddd;
      }

   #loadingOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
  pointer-events: auto;
}

#loadingContent {
  display: flex;
  flex-direction: column;  /* <-- to ustawia wszystko pionowo */
  align-items: center;
  gap: 20px;
  text-align: center;
}

#loadingLogo {
  width: 250px;
  height: auto;
  opacity: 0.9;
}

#loadingIcon {
  width: 50px;
  height: 50px;
  animation: spin 1.2s linear infinite;
  opacity: 0.8;
}

#loadingText {
  font-size: 1.2em;
  color: #333;
  opacity: 0.8;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

      /* Spinner - animowane kółko */
      #loadingOverlay .spinner {
        border: 5px solid #f3f3f3; /* jasnoszary */
        border-top: 5px solid #3498db; /* niebieski */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .tile {
        width: 140px;
        margin: 10px;
        display: inline-block;
        cursor: pointer;
      }

      .tile img {
        width: 100%;
        height: auto;
        border-radius: 6px;
        box-shadow: 0 0 4px rgba(0,0,0,0.1);
      }

      .tile div {
        text-align: center;
        margin-top: 5px;
      }

      h3 {
        margin-top: 0;
      }

      .tile-price {
  font-size: 0.9em;
  color: #555;
  margin-top: 4px;
}

html, body {
  overflow: hidden;
  height: 100%;
}



    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="viewer">
  <div id="loadingOverlay">
    <div id="loadingContent">
      <img id="loadingLogo" src="icons/FK_Logo.jpg" alt="Logo" />
      <img id="loadingIcon" src="icons/CircleLoad.png" alt="Loading..." />
      <div id="loadingText">Loading...</div>
    </div>
  </div>
</div>
<div id="ui"></div>

    <script type="module">
  import * as THREE from "three";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 510) / window.innerHeight, 0.1, 100);
  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth - 510, window.innerHeight);
  renderer.shadowMap.enabled = false;
  document.getElementById("viewer").appendChild(renderer.domElement);

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.85);
  directionalLight.position.set(5, 10, 7);
  directionalLight.castShadow = false;
  scene.add(directionalLight);

  const loader = new GLTFLoader();
  let currentModel;
  let modelCenter = new THREE.Vector3(0, 0, 0);
  const loadingOverlay = document.getElementById("loadingOverlay");

  let targetCameraZ = camera.position.z = 5;
  const minCameraZ = 0.6;
  const maxCameraZ = 1.8;
  const zoomSpeed = 0.001;
  const zoomLerpFactor = 0.1;

  const controls = { userIsInteracting: false };
  let previousMouseX = 0;
  let previousMouseY = 0;

  function onMouseDown(event) {
    controls.userIsInteracting = true;
    previousMouseX = event.clientX;
    previousMouseY = event.clientY;
  }

  function onMouseMove(event) {
    if (controls.userIsInteracting && currentModel) {
      const deltaX = event.clientX - previousMouseX;
      const deltaY = event.clientY - previousMouseY;

      currentModel.rotation.y += deltaX * 0.005;
      currentModel.rotation.x += deltaY * 0.003;
      currentModel.rotation.x = Math.min(Math.max(currentModel.rotation.x, -Math.PI / 4), Math.PI / 4);

      previousMouseX = event.clientX;
      previousMouseY = event.clientY;
    }
  }

  function onMouseUp() {
    controls.userIsInteracting = false;
  }

  window.addEventListener("mousedown", onMouseDown);
  window.addEventListener("mousemove", onMouseMove);
  window.addEventListener("mouseup", onMouseUp);

  window.addEventListener("wheel", (event) => {
    if (!currentModel) return;
    targetCameraZ += event.deltaY * zoomSpeed;
    targetCameraZ = Math.min(Math.max(targetCameraZ, minCameraZ), maxCameraZ);
  });

  function loadModel(name) {
    const path = `chairs/${name}.glb`;
    loadingOverlay.style.display = "flex";

    if (currentModel) {
      scene.remove(currentModel);
      currentModel.traverse((child) => {
        if (child.geometry) child.geometry.dispose();
        if (child.material) {
          if (Array.isArray(child.material)) child.material.forEach((mat) => mat.dispose());
          else child.material.dispose();
        }
      });
    }

    loader.load(
      path,
      (gltf) => {
        currentModel = gltf.scene;
        scene.add(currentModel);

        currentModel.traverse((child) => {
          if (child.isMesh) {
            // shadow disabled
          }
        });

        const box = new THREE.Box3().setFromObject(currentModel);
        const sizeVec = box.getSize(new THREE.Vector3());
        const size = sizeVec.length();
        modelCenter = box.getCenter(new THREE.Vector3());

        currentModel.position.sub(modelCenter);

        camera.position.set(0, size * 0.2, size * 1.2);
        targetCameraZ = camera.position.z;
        camera.lookAt(0, 0, 0);

        loadingOverlay.style.display = "none";
      },
      undefined,
      (error) => {
        console.error("❌ Błąd ładowania modelu:", error);
        loadingOverlay.innerHTML = "❌ Błąd ładowania modelu";
        loadingOverlay.style.display = "flex";
      }
    );
  }

  function animate() {
    requestAnimationFrame(animate);
    camera.position.z += (targetCameraZ - camera.position.z) * zoomLerpFactor;
    if (currentModel) camera.lookAt(0, 0, 0);
    if (currentModel && !controls.userIsInteracting) currentModel.rotation.y += 0.0005;
    renderer.render(scene, camera);
  }

  animate();

  async function loadSheetData() {
    const res = await fetch("https://opensheet.elk.sh/1vCs6YeHgKqlYwg8rvJOqVzNRnXeATJCBuK-zh3NNj78/Dane");
    const data = await res.json();
    return data;
  }

  function createTile(item) {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("data-nazwa", item.Nazwa);
    tile.innerHTML = `
      <img src="${item.Obrazek}" alt="${item.Nazwa}" />
      <div class="tile-title">${item.Nazwa}</div>
      <div class="tile-price">${item.Cena ? item.Cena + ' zł' : ''}</div>
    `;
    tile.addEventListener("click", () => loadModel(item.Nazwa));
    return tile;
  }

  async function initUI() {
    const ui = document.getElementById("ui");

    // Kontener przycisków kategorii
    const buttonsContainer = document.createElement("div");
    buttonsContainer.style.display = "flex";
    buttonsContainer.style.gap = "10px";
    buttonsContainer.style.marginBottom = "20px";

    const chairBtn = document.createElement("button");
    chairBtn.textContent = "Krzesła";
    chairBtn.style.flex = "1";
    chairBtn.onclick = () => showCategory("chairs");

    const materialsBtn = document.createElement("button");
    materialsBtn.textContent = "Materiały";
    materialsBtn.style.flex = "1";
    materialsBtn.onclick = () => showCategory("materials");

    buttonsContainer.appendChild(chairBtn);
    buttonsContainer.appendChild(materialsBtn);
    ui.appendChild(buttonsContainer);

    // Pobierz dane z arkusza
    const data = await loadSheetData();

    // Podział na kategorie wg Grupa
    const chairs = data.filter(item => item.Grupa === "krzesło" || item.Grupa === "kubełek");
    const materials = data.filter(item => item.Grupa === "tkanina" || item.Grupa === "drewno" || item.Grupa === "metal");

    // Sekcja krzeseł
    const chairSection = document.createElement("div");
    chairSection.id = "section-chairs";
    const header1 = document.createElement("h3");
    header1.textContent = "Wybierz krzesło";
    chairSection.appendChild(header1);
    chairs.forEach(item => {
      const tile = createTile(item);
      chairSection.appendChild(tile);
    });
    ui.appendChild(chairSection);

    // Sekcja materiałów
    const materialSection = document.createElement("div");
    materialSection.id = "section-materials";
    materialSection.style.display = "none";
    const header2 = document.createElement("h3");
    header2.textContent = "Wybierz materiał";
    materialSection.appendChild(header2);
    materials.forEach(item => {
      const tile = createTile(item);
      materialSection.appendChild(tile);
    });
    ui.appendChild(materialSection);

    // Załaduj domyślnie pierwszy model z krzeseł
    if (chairs.length > 0) loadModel(chairs[0].Nazwa);
  }

  function showCategory(name) {
    document.getElementById("section-chairs").style.display = name === "chairs" ? "block" : "none";
    document.getElementById("section-materials").style.display = name === "materials" ? "block" : "none";
  }

  initUI();

  window.addEventListener("resize", () => {
    camera.aspect = (window.innerWidth - 510) / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth - 510, window.innerHeight);
  });

  // Zablokuj scroll strony podczas zoomu modelu
  document.addEventListener('wheel', function(e) {
    e.preventDefault();
  }, { passive: false });

</script>

  </body>
</html>
